{% include 'admin_dashboard_base.html' %}
{% load static %}
{% block content %}
<div class="page-wrapper">
    <div class="content">
        <div class="page-header">
            <div class="page-title">
                <h4>{% if edit_mode %}Edit{% else %}Add{% endif %} Product</h4>
                <h6>{% if edit_mode %}Modify Existing{% else %}Create New{% endif %} Product</h6>
            </div>
            
        </div>

        <!-- Product Form -->
        <div class="card mt-3">
            <div class="card-body">
                <form id="productForm" action="{% if edit_mode %}{% url 'admin_dashboard-product_edit' pk=product.pk %}{% else %}{% url 'admin_dashboard-product_add' %}{% endif %}" 
                      method="post" 
                      enctype="multipart/form-data">
                    {% csrf_token %}

                    <div class="row">
                        <!-- Left Column -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.name.label_tag }}
                                {{ form.name }}
                                {% if form.name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.name.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                {{ form.short_description.label_tag }}
                                {{ form.short_description }}
                                {% if form.short_description.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.short_description.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                {{ form.detailed_description.label_tag }}
                                {{ form.detailed_description }}
                                {% if form.detailed_description.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.detailed_description.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Specifications Section -->
                            <div class="mb-3">
                                <label class="form-label">Product Specifications</label>
                                <div id="specificationsContainer">
                                    <!-- Dynamic specification rows will be added here -->
                                </div>
                                <button type="button" class="btn btn-secondary mt-2" id="addSpecificationBtn">
                                    <i class="fas fa-plus"></i> Add Specification
                                </button>
                                {% if form.specifications.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.specifications.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            {{ form.specifications }}
                        </div>

                        <!-- Right Column -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.categories.label_tag }}
                                {{ form.categories }}
                                {% if form.categories.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.categories.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                {{ form.quantity_in_stock.label_tag }}
                                {{ form.quantity_in_stock }}
                                {% if form.quantity_in_stock.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.quantity_in_stock.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                {{ form.main_image.label_tag }}
                                {{ form.main_image }}
                                {% if form.main_image.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.main_image.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                {% if product.main_image %}
                                    <div class="mt-2">
                                        <img src="{{ product.main_image.url }}" alt="Current main image" class="img-thumbnail" style="max-height: 100px;">
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                {{ form.additional_images.label_tag }}
                                {{ form.additional_images }}
                                {% if form.additional_images.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.additional_images.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                {% if existing_images %}
                                    <div class="mt-2">
                                        {% for image in existing_images %}
                                            <div class="d-inline-block position-relative me-2 mb-2">
                                                <img src="{{ image.product_image.url }}" alt="Product image" class="img-thumbnail" style="max-height: 100px;">
                                                <div class="form-check position-absolute top-0 end-0">
                                                    <input type="checkbox" name="images_to_remove" value="{{ image.id }}" class="form-check-input bg-danger">
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                {{ form.additional_documents.label_tag }}
                                {{ form.additional_documents }}
                                {% if form.additional_documents.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.additional_documents.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                {% if existing_documents %}
                                    <div class="mt-2">
                                        {% for doc in existing_documents %}
                                            <div class="d-flex align-items-center mb-2">
                                                <div class="form-check me-2">
                                                    <input type="checkbox" name="documents_to_remove" value="{{ doc.id }}" class="form-check-input">
                                                </div>
                                                <a href="{{ doc.document.url }}" target="_blank" class="text-decoration-none">
                                                    <i class="fas fa-file me-1"></i>{{ doc.title }}
                                                </a>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="text-end mt-3">
                        <button type="submit" class="btn btn-primary">
                            {% if edit_mode %}Update{% else %}Add{% endif %} Product
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize Select2
    $('#id_categories').select2({
        theme: 'bootstrap4',
        placeholder: 'Select categories',
        allowClear: true
    });

    // Initialize Summernote for detailed description
    $('#id_detailed_description').summernote({
        height: 200,
        toolbar: [
            ['style', ['bold', 'italic', 'underline', 'clear']],
            ['font', ['strikethrough']],
            ['para', ['ul', 'ol']],
            ['insert', ['link']],
            ['view', ['fullscreen', 'codeview']]
        ]
    });

    // Specifications handling
    const specificationsContainer = $('#specificationsContainer');
    const addSpecificationBtn = $('#addSpecificationBtn');
    const specificationsInput = $('#id_specifications');

    function createSpecificationRow(title = '', value = '') {
        const rowId = 'spec-' + Date.now();
        const row = $(`
            <div class="specification-row mb-3" id="${rowId}">
                <div class="row">
                    <div class="col-md-5">
                        <input type="text" class="form-control spec-title" placeholder="Specification Title" value="${escapeHtml(title)}">
                    </div>
                    <div class="col-md-6">
                        <textarea class="form-control spec-value" placeholder="Specification Value">${escapeHtml(value)}</textarea>
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-danger btn-sm remove-spec">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        `);

        // Initialize Summernote for the value field
        row.find('.spec-value').summernote({
            height: 100,
            toolbar: [
                ['style', ['bold', 'italic', 'underline']],
                ['para', ['ul', 'ol']],
                ['view', ['fullscreen']]
            ],
            callbacks: {
                onChange: updateSpecificationsData
            }
        });

        // Add event listeners
        row.find('.remove-spec').on('click', function() {
            row.remove();
            updateSpecificationsData();
        });

        row.find('.spec-title').on('input', updateSpecificationsData);

        return row;
    }

    function updateSpecificationsData() {
        const specifications = [];
        
        $('.specification-row').each(function() {
            const title = $(this).find('.spec-title').val().trim();
            const value = $(this).find('.spec-value').summernote('code').trim();
            
            if (title && value) {
                specifications.push({
                    title: title,
                    value: value
                });
            }
        });

        specificationsInput.val(JSON.stringify(specifications));
    }

    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Add specification button click handler
    addSpecificationBtn.on('click', function() {
        specificationsContainer.append(createSpecificationRow());
    });

    // Initialize existing specifications if any
    const existingSpecs = {{ specifications_json|default:'[]'|safe }};
    if (existingSpecs.length > 0) {
        existingSpecs.forEach(spec => {
            specificationsContainer.append(createSpecificationRow(spec.title, spec.value));
        });
    } else {
        // Add one empty row by default
        specificationsContainer.append(createSpecificationRow());
    }

    // Form submission handling
    $('#productForm').on('submit', function(e) {
        updateSpecificationsData();
        
        // Basic validation
        if ($('.specification-row').length === 0) {
            e.preventDefault();
            alert('Please add at least one specification');
            return false;
        }

        let isValid = true;
        $('.specification-row').each(function() {
            const title = $(this).find('.spec-title').val().trim();
            const value = $(this).find('.spec-value').summernote('code').trim();

            if (!title || !value) {
                isValid = false;
                return false;
            }
        });

        if (!isValid) {
            e.preventDefault();
            alert('Please fill in all specification fields');
            return false;
        }
    });
});
</script>
{% endblock %}
